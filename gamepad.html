<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stack Gamepad</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #111;
    }

    #touchButton {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8vw;
      color: #fff;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      background-color: #222;
    }
  </style>
</head>

<body>
  <div id="touchButton">TAP TO STACK</div>

  <!-- 1) Include the Photon Realtime JS SDK (v4.3.2). -->
  <script src="lib/photon.js"></script>
  <script>
    (function () {
      // ────────────────────────────────────────────────────────────────────────
      // A) READ URL PARAMETERS:  ?appId=…&room=…&player=0/1/2
      // ────────────────────────────────────────────────────────────────────────
      const params = new URLSearchParams(window.location.search);
      const appIdParam = params.get("appId");
      const roomParam = params.get("room");
      const playerParam = parseInt(params.get("player"), 10);

      if (!appIdParam || !roomParam || isNaN(playerParam)) {
        document.getElementById("touchButton").innerText =
          "Invalid URL parameters.\nExpected: ?appId=…&room=…&player=0/1/2";
        console.error("Missing or invalid URL parameters.");
        return;
      }

      // ────────────────────────────────────────────────────────────────────────
      // B) CREATE & CONFIGURE LoadBalancingClient
      //    - Using ConnectionProtocol.Udp (WebSocket under the hood)
      //    - Must match your server’s region ("eu")
      // ────────────────────────────────────────────────────────────────────────
      // Photon.ConnectionProtocol.Udp = 0  (this still routes over WSS by default).
      const client = new Photon.LoadBalancing.LoadBalancingClient(
        Photon.ConnectionProtocol.Udp,
        appIdParam,
        "1.0" // app version; keep in sync with your Unity host version
      );
      client.logger = new Photon.Logger("JS");
      client.logger.setLevel(Photon.LogLevel.INFO);

      // (1) Called once we connect to Photon Master
      client.onConnectedToMaster = function () {
        console.log("[JS] onConnectedToMaster → joining room:", roomParam);

        // join or create "roomParam", maxPlayers left to server defaults.
        client.joinOrCreateRoom(
          roomParam,
          {},       // no custom RoomOptions needed
          {}        // no LobbyOptions needed
        );
      };

      // (2) Called when we successfully join/create the room
      client.onJoinedRoom = function () {
        console.log("[JS] onJoinedRoom → IN ROOM:", roomParam, "PLAYER:", playerParam);
        document.getElementById("touchButton").innerText =
          "IN STACK ROOM\nPLAYER " + playerParam;
      };

      // (3) Called if join/create failed
      client.onJoinRoomFailed = function (returnCode, errorMsg) {
        console.error("[JS] onJoinRoomFailed(", returnCode, "):", errorMsg);
        document.getElementById("touchButton").innerText =
          "Failed to join room.\nSee console.";
      };

      client.onError = function (errorCode, errorMsg) {
        console.error("[JS] Photon Error:", errorCode, errorMsg);
      };

      // We don’t need to handle incoming events on the JS side in this simple flow,
      // but you can implement client.onEvent if needed.
      client.onEvent = function (code, content, actorNr) {
        // No-op (we only send taps from JS; Unity logs them).
      };

      // ────────────────────────────────────────────────────────────────────────
      // C) START CONNECTION
      // ────────────────────────────────────────────────────────────────────────
      client.connect(); // This calls connectToRegionMaster("eu") under the hood

      // ────────────────────────────────────────────────────────────────────────
      // D) ON TAP: raiseEvent code=1 with content=playerParam
      //    (Matches Unity’s buttonEventCode = 1)
      // ────────────────────────────────────────────────────────────────────────
      function sendTap(evt) {
        evt.preventDefault();
        if (client.getState() !== Photon.LoadBalancing.LoadBalancingClientState.Joined) {
          console.warn("[JS] Tried to tap before joining room.");
          return;
        }
        // RaiseEvent(eventCode, content, RaiseEventOptions, SendOptions)
        client.raiseEvent(
          /* eventCode = */ 1,
          /* content   = */ playerParam,
          /* options   = */ new Photon.LoadBalancing.RaiseEventOptions({
          Receivers: Photon.LoadBalancing.ReceiverGroup.All
        }),
          /* sendOpts  = */ new Photon.SendOptions({ Reliability: true })
        );
        console.log("[JS] Sent tap for player", playerParam);
      }

      // Hook touchstart and mousedown
      const buttonDiv = document.getElementById("touchButton");
      buttonDiv.addEventListener("touchstart", sendTap, { passive: false });
      buttonDiv.addEventListener("mousedown", sendTap);
    })();
  </script>
</body>

</html>