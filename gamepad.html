<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stack Gamepad</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #111;
    }

    #touchButton {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8vw;
      color: #fff;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      background-color: #222;
    }
  </style>
</head>

<body>
  <div id="touchButton">TAP TO STACK</div>

  <!--
    1) Load Photon Realtime v5.1.5 UMD build (true browser‐ready bundle).
       We’re using unpkg.com here. This will expose `window.PhotonRealtime`.
  -->
  <script src="https://unpkg.com/photon-realtime@5.1.5/build/photon-realtime.umd.min.js"></script>
  <script>
    (function () {
      // 2) Parse URL parameters: ?appId=…&room=…&player=…
      const params = new URLSearchParams(window.location.search);
      const appIdParam = params.get("appId");
      const roomParam = params.get("room");
      const playerParam = parseInt(params.get("player"), 10);

      if (!appIdParam || !roomParam || isNaN(playerParam)) {
        document.getElementById("touchButton").innerText =
          "Invalid URL parameters.\nExpected: ?appId=…&room=…&player=0/1/2";
        console.error("Missing or invalid URL parameters.");
        return;
      }

      // 3) Create a LoadBalancingClient (v5.x namespace = PhotonRealtime)
      //    PhotonRealtime.ConnectionProtocol.Udp → Use the same protocol you used in Unity.
      const region = "eu";  // Must match the “FixedRegion” you used in Unity (e.g. "eu" or "us").
      const client = new PhotonRealtime.LoadBalancingClient(
        PhotonRealtime.ConnectionProtocol.Udp
      );
      client.setLogLevel(PhotonRealtime.DebugLevel.WARNING);

      // 4) Hook up the callbacks
      client.addCallbackTarget({
        onConnected: () => {
          console.log("[JS] onConnected()");
        },
        onConnectedToMaster: () => {
          console.log("[JS] onConnectedToMaster → joining room:", roomParam);
          client.joinRoom(roomParam);
        },
        onJoinRoomFailed: (code, msg) => {
          console.error(`[JS] onJoinRoomFailed(${code}): ${msg}`);
          document.getElementById("touchButton").innerText =
            "Failed to join room.\nCheck console.";
        },
        onJoinedRoom: () => {
          console.log("[JS] onJoinedRoom()");
          document.getElementById("touchButton").innerText =
            "IN STACK ROOM\nPLAYER " + playerParam;
        },
        onError: (errorCode, errorMsg) => {
          console.error("[JS] Photon Error:", errorCode, errorMsg);
        },
        onEvent: (evData) => {
          // We don’t need to handle incoming events on the “gamepad” side.
        }
      });

      // 5) Connect to Photon Cloud
      client.connectUsingSettings({
        AppIdRealtime: appIdParam,
        AppVersion: "1.0",
        FixedRegion: region
      });

      // 6) On “touchstart” (mobile) or “mousedown” (desktop), send a RaiseEvent
      const buttonDiv = document.getElementById("touchButton");
      buttonDiv.addEventListener("touchstart", sendTap, { passive: false });
      buttonDiv.addEventListener("mousedown", sendTap);

      function sendTap(evt) {
        evt.preventDefault();
        // Only send if we’re already in the room
        if (client.getState() !== PhotonRealtime.ClientState.Joined) {
          console.warn("[JS] Tried to tap before joining room.");
          return;
        }
        // EventCode = 1 means “button press.” Content is the integer player index (0, 1, or 2).
        client.raiseEvent(
          /* eventCode = */ 1,
          /*   content = */ playerParam,
          /*   options = */ new PhotonRealtime.RaiseEventOptions({
          Receivers: PhotonRealtime.ReceiverGroup.All
        }),
          /*   sendOpts = */ new PhotonRealtime.SendOptions({ Reliability: true })
        );
      }
    })();
  </script>
</body>

</html>