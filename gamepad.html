<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Stack Gamepad</title>
  <style>
    /* Full‐screen black background */
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #111;
      color: #eee;
      font-family: Arial, sans-serif;
      overflow: hidden;
      touch-action: manipulation;
    }

    /* Container flex‐centers everything */
    #container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* Status text at top */
    #statusText {
      position: absolute;
      top: 5%;
      width: 100%;
      text-align: center;
      font-size: 4vw;
      line-height: 1.2;
      pointer-events: none;
      user-select: none;
    }

    /* Full‐screen tappable button area */
    #touchButton {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8vw;
      color: #fff;
      user-select: none;
      transition: background-color 0.1s ease;
    }

    #touchButton:active {
      background-color: #444;
    }

    /* (Optional) Debug log area at bottom */
    #logArea {
      position: absolute;
      bottom: 0;
      width: 100%;
      max-height: 25%;
      overflow-y: auto;
      background-color: rgba(0, 0, 0, 0.7);
      font-size: 2.5vw;
      line-height: 1.1;
      padding: 0.5em;
      box-sizing: border-box;
      display: none;
      /* Change to "block" to see debug logs */
    }

    #logArea div {
      margin-bottom: 0.2em;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="touchButton">TAP TO STACK</div>
    <div id="statusText">Connecting…</div>
    <div id="logArea"></div>
  </div>

  <!-- Photon Realtime JS SDK v4.3.2 -->
  <script src="lib/photon.js"></script>
  <script>
    (function () {


      let heartbeatInterval;
      let lastHeartbeat = Date.now();
      const HEARTBEAT_TIMEOUT = 10000; // 10 seconds
      const HEARTBEAT_INTERVAL = 3000; // 3 seconds

      function startHeartbeatMonitoring() {
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
        }

        heartbeatInterval = setInterval(() => {
          const timeSinceLastHeartbeat = Date.now() - lastHeartbeat;

          if (timeSinceLastHeartbeat > HEARTBEAT_TIMEOUT) {

            if (client.isJoinedToRoom()) {
              const exists = client.availableRooms().some(r => r.name === roomParam);
              if (!exists)
                // Force disconnect and attempt reconnection
                if (client && !client.isJoinedToRoom())
                  client.disconnect();

            }
          }
        }, HEARTBEAT_INTERVAL);
      }


      //────────────────────────────────────────────────────────────────────────
      // 1) Simple logger: writes to console and (optionally) #logArea
      //────────────────────────────────────────────────────────────────────────
      function logDebug(msg, ...args) {
        console.log(msg, ...args);
        const logArea = document.getElementById("logArea");
        if (logArea.style.display === "block") {
          const line = document.createElement("div");
          line.textContent = "[JS] " + msg + (args.length ? " " + args.join(" ") : "");
          logArea.appendChild(line);
          logArea.scrollTop = logArea.scrollHeight;
        }
      }

      //────────────────────────────────────────────────────────────────────────
      // 2) Parse & validate URL params: appId, room, player
      //    Usage: ?appId=YOUR_APP_ID&room=OpenStackRoom&player=0
      //────────────────────────────────────────────────────────────────────────
      const params = new URLSearchParams(window.location.search);
      const appIdParam = params.get("appId");
      const roomParam = params.get("room");
      const playerStr = params.get("player");
      const regionParam = params.get("region") || "eu";
      const statusText = document.getElementById("statusText");
      const touchDiv = document.getElementById("touchButton");

      if (!appIdParam || !roomParam || playerStr === null) {
        statusText.textContent =
          "❗ Invalid parameters.\nUse: ?appId=…&room=…&player=0/1/2";
        console.error("Missing or invalid URL params. Must include appId, room, player.");
        return;
      }

      const playerIndex = parseInt(playerStr, 10);
      if (isNaN(playerIndex) || playerIndex < 0) {
        statusText.textContent = "❗  Invalid parameters.\nUse: ?appId=…&room=…&player=0/1/2&region=uae";
        console.error("player query‐param is not a non‐negative integer:", playerStr);
        return;
      }

      //────────────────────────────────────────────────────────────────────────
      // 3) Instantiate LoadBalancingClient with secure WSS
      //────────────────────────────────────────────────────────────────────────
      const client = new Photon.LoadBalancing.LoadBalancingClient(
        Photon.ConnectionProtocol.Wss,  // ← Wss required for HTTPS pages
        appIdParam,                    // Photon Cloud AppId
        "1.0"                          // AppVersion (match Unity side)
      );

      // Set up logging
      if (client.setLogLevel) {
        client.setLogLevel(Photon.LogLevel.INFO);
      }

      //────────────────────────────────────────────────────────────────────────
      // 4) onStateChange: update #statusText with a readable state
      //────────────────────────────────────────────────────────────────────────
      client.onStateChange = function (state) {
        const stateName = Photon.LoadBalancing.LoadBalancingClient.StateToName(state);
        let displayText;

        switch (state) {
          case Photon.LoadBalancing.LoadBalancingClient.State.ConnectingToNameServer:
            displayText = "Connecting to NameServer…";
            break;
          case Photon.LoadBalancing.LoadBalancingClient.State.ConnectedToNameServer:
            displayText = "Connected to NameServer…";
            break;
          case Photon.LoadBalancing.LoadBalancingClient.State.ConnectingToMasterserver:
            displayText = "Connecting to Master…";
            break;
          case Photon.LoadBalancing.LoadBalancingClient.State.ConnectedToMaster:
            displayText = "Connected to Master…";
            break;
          case Photon.LoadBalancing.LoadBalancingClient.State.JoinedLobby:
            displayText = "In Lobby. Joining Room…";
            break;
          case Photon.LoadBalancing.LoadBalancingClient.State.ConnectingToGameserver:
            displayText = `Joining Room "${roomParam}"…`;
            break;
          case Photon.LoadBalancing.LoadBalancingClient.State.Joined:
            displayText = `✅ Joined Room "${roomParam}"\nPLAYER ${playerIndex}`;
            lastHeartbeat = Date.now(); // Reset heartbeat
            startHeartbeatMonitoring(); // Start monitoring
            break;
          case Photon.LoadBalancing.LoadBalancingClient.State.Disconnected:
            displayText = "❌ Disconnected";
            break;
          case Photon.LoadBalancing.LoadBalancingClient.State.Error:
            displayText = "❌ Error occurred";
            break;
          default:
            displayText = stateName || "Unknown State";
        }

        statusText.textContent = displayText;
        logDebug("onStateChange →", stateName, "| Display:", displayText.replace(/\n/g, " | "));

        // Join room when we reach JoinedLobby state
        if (state === Photon.LoadBalancing.LoadBalancingClient.State.JoinedLobby) {
          attemptJoinRoom();
        }
      };

      const originalOnEvent = client.onEvent;
      client.onEvent = function (eventCode, data, actorNr) {
        lastHeartbeat = Date.now(); // Reset heartbeat on any received event
        if (originalOnEvent) {
          originalOnEvent.call(this, eventCode, data, actorNr);
        }
      };

      // Add cleanup when page unloads:
      window.addEventListener('beforeunload', function () {
        if (heartbeatInterval) {
          clearInterval(heartbeatInterval);
        }
      });

      //────────────────────────────────────────────────────────────────────────
      // 5) Function to attempt joining room (called when in lobby)
      //────────────────────────────────────────────────────────────────────────
      function attemptJoinRoom() {
        logDebug("Now in lobby, attempting to join/create room:", roomParam);

        // Use joinRoom 
        const joinResult = client.joinRoom(roomParam, null, null);

        if (!joinResult) {
          console.error("Failed to send join room request");
          statusText.textContent = "❌ Failed to join room";
        } else {
          logDebug("Join room request sent successfully");
        }
      }

      //────────────────────────────────────────────────────────────────────────
      // 6) Connection flow handlers
      //────────────────────────────────────────────────────────────────────────

      // Handle successful connection to NameServer
      client.onConnectedToNameServer = function () {
        logDebug(`Connected to NameServer, now connecting to region master '${regionParam}'`);

        const result = client.connectToRegionMaster(regionParam.toLowerCase());
        if (!result) {
          console.error("Failed to connect to region master");
          statusText.textContent = `❌ Failed to connect to region ${regionParam}`;
        }
      };

      // Handle successful connection to Master server
      client.onConnectedToMaster = function () {
        logDebug("Connected to Master server, waiting to join lobby...");
      };

      //────────────────────────────────────────────────────────────────────────
      // 7) onJoinRoom: room joined successfully
      //────────────────────────────────────────────────────────────────────────
      client.onJoinRoom = function (createdByMe) {
        logDebug("onJoinRoom → joined", roomParam, "created by me:", createdByMe);
      };

      //────────────────────────────────────────────────────────────────────────
      // 8) Handle operation responses for better error handling
      //────────────────────────────────────────────────────────────────────────
      client.onOperationResponse = function (errorCode, errorMsg, code, content) {
        if (errorCode !== 0) {
          console.error("Operation failed:", code, "Error:", errorCode, errorMsg);
          logDebug("Operation error:", code, errorCode, errorMsg);

          // Handle specific join room failures
          if (code === Photon.LoadBalancing.Constants.OperationCode.JoinGame) {
            statusText.textContent = `❌ Failed to join "${roomParam}"\nError: ${errorMsg}`;
          }
        } else {
          logDebug("Operation success:", code);
        }
      };

      //────────────────────────────────────────────────────────────────────────
      // 9) onError: generic error handler
      //────────────────────────────────────────────────────────────────────────
      client.onError = function (errorCode, errorMsg) {
        console.error("Photon Error:", errorCode, errorMsg);
        logDebug("Photon Error:", errorCode, errorMsg);
        statusText.textContent = `⚠️ Photon Error: ${errorMsg}`;
      };

      //────────────────────────────────────────────────────────────────────────
      // 10) Start connection - connect to NameServer first
      //────────────────────────────────────────────────────────────────────────
      logDebug(`Starting connection to NameServer with region: ${regionParam}...`);
      const connectResult = client.connectToNameServer({
        region: regionParam.toLowerCase()
      });

      if (!connectResult) {
        console.error("Failed to start connection to NameServer");
        statusText.textContent = "❌ Failed to start connection";
      }

      //────────────────────────────────────────────────────────────────────────
      // 11) On tap/click: send RaiseEvent(eventCode=1, content=playerIndex)
      //      (Only if client is joined to room)
      //────────────────────────────────────────────────────────────────────────
      function sendTap(evt) {
        evt.preventDefault();

        // Check if client is properly connected and in room
        if (!client || !client.isJoinedToRoom()) {
          console.warn("Tap attempted before joining room. Current state:", client?.state?.() || "unknown");
          return;
        }

        // Prevent rapid-fire tapping
        const now = Date.now();
        if (sendTap.lastTap && (now - sendTap.lastTap) < 100) {
          return; // Debounce: ignore taps within 100ms
        }
        sendTap.lastTap = now;

        // Ensure we send an integer (not a string or other type)
        const playerData = parseInt(playerIndex, 10);

        logDebug("Sending tap event with data:", playerData, "type:", typeof playerData);

        try {
          // Use the correct raiseEvent API - the return value might not be reliable
          client.raiseEvent(
            1,           // eventCode
            playerData,  // data - explicitly as integer
            {            // options
              receivers: Photon.LoadBalancing.Constants.ReceiverGroup.All,
              cache: Photon.LoadBalancing.Constants.EventCaching.DoNotCache
            }
          );

          logDebug("Tap event sent for player", playerIndex);

          // Visual feedback - always show since the event is likely sent successfully
          touchDiv.style.backgroundColor = "#555";
          setTimeout(() => {
            touchDiv.style.backgroundColor = "#222";
          }, 100);

        } catch (error) {
          console.error("Exception while sending tap event:", error);
        }
      }

      // Hook both touchstart and mousedown for mobile & desktop
      touchDiv.addEventListener("touchstart", sendTap, { passive: false });
      touchDiv.addEventListener("mousedown", sendTap);

      //────────────────────────────────────────────────────────────────────────
      // 12) Prevent context menu on long‐press
      //────────────────────────────────────────────────────────────────────────
      window.addEventListener("contextmenu", function (e) {
        e.preventDefault();
      });

      //────────────────────────────────────────────────────────────────────────
      // 13) Prevent double-tap zoom on mobile
      //────────────────────────────────────────────────────────────────────────
      let lastTouchEnd = 0;
      touchDiv.addEventListener('touchend', function (event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);

      //────────────────────────────────────────────────────────────────────────
      // 14) Handle page visibility changes
      //────────────────────────────────────────────────────────────────────────
      document.addEventListener('visibilitychange', function () {
        if (document.hidden) {
          logDebug("Page became hidden");
        } else {
          logDebug("Page became visible");
          // Optionally reconnect if needed
        }
      });

    })();
  </script>
</body>

</html>