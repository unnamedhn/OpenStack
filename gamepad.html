<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stack Gamepad</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #111;
    }

    #touchButton {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8vw;
      color: #fff;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      background-color: #222;
      text-align: center;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div id="touchButton">TAP TO STACK</div>

  <!-- Photon Realtime JavaScript SDK v4.3.2 (make sure this file exists) -->
  <script src="lib/photon.js"></script>
  <script>
    (function () {
      // ────────────────────────────────────────────────────────────────────────
      // A) PARSE URL PARAMETERS:  ?appId=…&room=…&player=0/1/2
      // ────────────────────────────────────────────────────────────────────────
      const params = new URLSearchParams(window.location.search);
      const appIdParam = params.get("appId");
      const roomParam = params.get("room");
      const playerParam = parseInt(params.get("player"), 10);

      if (!appIdParam || !roomParam || isNaN(playerParam)) {
        document.getElementById("touchButton").innerText =
          "Invalid URL parameters.\nExpected: ?appId=…&room=…&player=0/1/2";
        console.error("Missing or invalid URL parameters.");
        return;
      }

      // ────────────────────────────────────────────────────────────────────────
      // B) CREATE & CONFIGURE LoadBalancingClient (v4.3.2)
      //    - Use ConnectionProtocol.Wss so the browser opens a secure WebSocket
      //    - Then explicitly connectToRegionMaster("eu")
      // ────────────────────────────────────────────────────────────────────────
      const client = new Photon.LoadBalancing.LoadBalancingClient(
        Photon.ConnectionProtocol.Wss, // ← Must be Wss in an HTTPS‐served page
        appIdParam,
        "1.0"                          // AppVersion (match your Unity host)
      );
      client.logger = new Photon.Logger("JS");
      client.logger.setLevel(Photon.LogLevel.INFO);

      // 1) onConnectedToMaster  →  join or create the room
      client.onConnectedToMaster = function () {
        console.log("[JS] onConnectedToMaster → joining room:", roomParam);
        client.joinOrCreateRoom(
          roomParam,  // room name (must match Unity’s “OpenStackRoom”)
          {},         // no custom RoomOptions
          {}          // no LobbyOptions
        );
      };

      // 2) onJoinedRoom → update the UI so user knows they’re in
      client.onJoinedRoom = function () {
        console.log("[JS] onJoinedRoom → IN ROOM:", roomParam, "PLAYER:", playerParam);
        document.getElementById("touchButton").innerText =
          "IN STACK ROOM\nPLAYER " + playerParam;
      };

      // 3) onJoinRoomFailed → show error on the button itself
      client.onJoinRoomFailed = function (returnCode, errorMsg) {
        console.error("[JS] onJoinRoomFailed(", returnCode, "):", errorMsg);
        document.getElementById("touchButton").innerText =
          "Failed to join room.\nSee console.";
      };

      // Generic error callback
      client.onError = function (errorCode, errorMsg) {
        console.error("[JS] Photon Error:", errorCode, errorMsg);
      };

      // We don’t need to process inbound events in this simple tap‐only flow:
      client.onEvent = function (code, content, actorNr) {
        // No‐op. (Unity is logging Raises on its side.)
      };

      // ────────────────────────────────────────────────────────────────────────
      // C) CONNECT TO REGION MASTER (EU)
      // ────────────────────────────────────────────────────────────────────────
      client.connectToRegionMaster("eu");
      // → This ensures “wss://<region>.p3photon.com:9093/…” under the hood instead of ws://.

      // ────────────────────────────────────────────────────────────────────────
      // D) ON TAP: raiseEvent(eventCode=1, content=playerParam)
      //    (Matches Unity’s `buttonEventCode = 1`)
      // ────────────────────────────────────────────────────────────────────────
      function sendTap(evt) {
        evt.preventDefault();
        if (client.getState() !== Photon.LoadBalancing.LoadBalancingClientState.Joined) {
          console.warn("[JS] Tried tapping before actually joining the room.");
          return;
        }

        client.raiseEvent(
          /* eventCode = */ 1,
          /* content   = */ playerParam,
          /* options   = */ new Photon.LoadBalancing.RaiseEventOptions({
          Receivers: Photon.LoadBalancing.ReceiverGroup.All
        }),
          /* sendOpts  = */ new Photon.SendOptions({ Reliability: true })
        );
        console.log("[JS] Sent tap for player", playerParam);
      }

      // Attach both touchstart and mousedown for desktop/mobile
      const buttonDiv = document.getElementById("touchButton");
      buttonDiv.addEventListener("touchstart", sendTap, { passive: false });
      buttonDiv.addEventListener("mousedown", sendTap);
    })();
  </script>
</body>

</html>