<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stack Gamepad</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #111;
    }

    #touchButton {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8vw;
      color: #fff;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      background-color: #222;
    }
  </style>
</head>

<body>
  <div id="touchButton">TAP TO STACK</div>

  <!--
    1) Load Photon JavaScript SDK v5.1.5 UMD build.
       This exposes `window.Photon` (not PhotonRealtime).
  -->
  <script src="https://cdn.jsdelivr.net/npm/photon-javascript-sdk@5.1.5/dist/photon-javascript-sdk.umd.min.js"></script>
  <script>
    (function () {
      // 2) Verify that Photon loaded successfully:
      if (!window.Photon || !Photon.LoadBalancing) {
        console.error("Photon SDK failed to load.");
        alert("Error: Could not load Photon SDK. Check your network or script URL.");
        return;
      }

      // 3) Parse URL parameters: ?appId=…&room=…&player=…
      const params = new URLSearchParams(window.location.search);
      const appIdParam = params.get("appId");
      const roomParam = params.get("room");
      const playerParam = parseInt(params.get("player"), 10);

      if (!appIdParam || !roomParam || isNaN(playerParam)) {
        document.getElementById("touchButton").innerText =
          "Invalid URL parameters.\nUsage: ?appId=…&room=…&player=0/1/2";
        console.error("Missing or invalid URL parameters.");
        return;
      }

      // 4) Create a LoadBalancingClient using UDP protocol
      //    Arguments: (protocol, appId, appVersion)
      const region = "eu"; // Must match the FixedRegion used in Unity (e.g. "eu", "us", etc.)
      const client = new Photon.LoadBalancing.LoadBalancingClient(
        Photon.ConnectionProtocol.Udp,
        appIdParam,
        "1.0"
      );

      // 5) Set up state-change handler to join the room once connected
      client.onStateChange = function (state) {
        switch (state) {
          case Photon.LoadBalancing.LoadBalancingClient.State.ConnectedToMaster:
          case Photon.LoadBalancing.LoadBalancingClient.State.JoinedLobby:
            // Once we are in the lobby, join or create the specified room
            console.log("[JS] Joined Lobby → joining/creating room:", roomParam);
            client.joinOrCreateRoom(roomParam, {}, { maxPlayers: 3 });
            break;

          case Photon.LoadBalancing.LoadBalancingClient.State.Joined:
            // We have joined (or created) the room successfully
            console.log("[JS] Joined room:", roomParam);
            document.getElementById("touchButton").innerText =
              "IN STACK ROOM\nPLAYER " + playerParam;
            break;
        }
      };

      // 6) Handle errors for easier debugging
      client.onError = function (errorCode, errorMsg) {
        console.error("[JS] Photon Error:", errorCode, errorMsg);
      };
      client.onJoinRoomError = function (errorCode, errorMsg) {
        console.error(`[JS] onJoinRoomError(${errorCode}):`, errorMsg);
        document.getElementById("touchButton").innerText =
          "Failed to join room.\nSee console.";
      };

      // 7) Start connecting to Photon Cloud in the chosen region
      console.log("[JS] Connecting to Photon region:", region);
      client.connectToRegionMaster(region);

      // 8) Listen for taps (mobile “touchstart” or desktop “mousedown”) to send EventCode=1
      const buttonDiv = document.getElementById("touchButton");
      buttonDiv.addEventListener("touchstart", sendTap, { passive: false });
      buttonDiv.addEventListener("mousedown", sendTap);

      function sendTap(evt) {
        evt.preventDefault();
        // Only send if we are already joined in the room
        if (client.getState() !== Photon.LoadBalancing.LoadBalancingClient.State.Joined) {
          console.warn("[JS] Tap ignored: not yet in room.");
          return;
        }
        // Raise EventCode=1 with content = playerParam (0,1,2), sent to all peers
        client.raiseEvent(
          /* eventCode: */ 1,
          /*   content: */ playerParam,
          /*   options: */ new Photon.LoadBalancing.RaiseEventOptions({
          receivers: Photon.LoadBalancing.ReceiverGroup.All
        })
        );
      }
    })();
  </script>
</body>

</html>