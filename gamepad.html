<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stack Gamepad</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #111;
    }

    #touchButton {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8vw;
      color: #fff;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      background-color: #222;
    }
  </style>
</head>

<body>
  <div id="touchButton">TAP TO STACK</div>

  <!--
    1) Load Photon Realtime v4.3.2 UMD build from jsDelivr.
       This defines `window.PhotonRealtime`.
  -->
  <script src="https://cdn.jsdelivr.net/npm/photon-realtime@4.3.2/photon-realtime-module.js"></script>
  <script>
    (function () {
      // 2) Verify that PhotonRealtime loaded successfully:
      if (!window.PhotonRealtime || !PhotonRealtime.LoadBalancingClient) {
        console.error("PhotonRealtime SDK failed to load.");
        alert("Error: Could not load PhotonRealtime SDK. Check script URL.");
        return;
      }

      // 3) Parse URL parameters: ?appId=…&room=…&player=…
      const params = new URLSearchParams(window.location.search);
      const appIdParam = params.get("appId");
      const roomParam = params.get("room");
      const playerParam = parseInt(params.get("player"), 10);

      if (!appIdParam || !roomParam || isNaN(playerParam)) {
        document.getElementById("touchButton").innerText =
          "Invalid URL parameters.\nExpected: ?appId=…&room=…&player=0/1/2";
        console.error("Missing or invalid URL parameters.");
        return;
      }

      // 4) Create a PhotonRealtime LoadBalancingClient (UDP, appId, version)
      const region = "eu"; // Must match the `FixedRegion` used in Unity (e.g. "eu", "us", etc.)
      const client = new PhotonRealtime.LoadBalancingClient(
        PhotonRealtime.ConnectionProtocol.Udp,
        appIdParam,
        "1.0"
      );
      client.setLogLevel(PhotonRealtime.DebugLevel.WARNING);

      // 5) Handle state changes: join/create room when in lobby, update UI when joined
      client.onStateChange = function (state) {
        switch (state) {
          case PhotonRealtime.LoadBalancingClient.State.JoinedLobby:
            console.log("[JS] JoinedLobby → joinOrCreateRoom:", roomParam);
            client.joinOrCreateRoom(
              roomParam,
              { maxPlayers: 3 },  // RoomOptions
              null                // TypedLobby (null = default)
            );
            break;

          case PhotonRealtime.LoadBalancingClient.State.Joined:
            console.log("[JS] Joined room:", roomParam);
            document.getElementById("touchButton").innerText =
              "IN STACK ROOM\nPLAYER " + playerParam;
            break;
        }
      };

      // 6) Error handlers for easier debugging
      client.onError = function (errorCode, errorMsg) {
        console.error("[JS] Photon Error:", errorCode, errorMsg);
      };
      client.onJoinRoomError = function (errorCode, errorMsg) {
        console.error(`[JS] onJoinRoomError(${errorCode}):`, errorMsg);
        document.getElementById("touchButton").innerText =
          "Failed to join room.\nSee console.";
      };

      // 7) Connect to Photon Cloud’s Master server in the chosen region
      console.log("[JS] Connecting to Photon region:", region);
      client.connectToRegionMaster(region);

      // 8) On “touchstart” (mobile) or “mousedown” (desktop), raise EventCode=1 with content=playerParam
      const buttonDiv = document.getElementById("touchButton");
      buttonDiv.addEventListener("touchstart", sendTap, { passive: false });
      buttonDiv.addEventListener("mousedown", sendTap);

      function sendTap(evt) {
        evt.preventDefault();
        // Only send if we’re already Joined
        if (client.getState() !== PhotonRealtime.LoadBalancingClient.State.Joined) {
          console.warn("[JS] Tap ignored: not yet in room.");
          return;
        }
        // EventCode=1 signals “button press.” Payload = playerParam (integer 0/1/2).
        client.raiseEvent(
          /* eventCode */ 1,
          /*   content */ playerParam,
          /*   options */ new PhotonRealtime.RaiseEventOptions({
          receivers: PhotonRealtime.ReceiverGroup.All
        })
        );
      }
    })();
  </script>
</body>

</html>