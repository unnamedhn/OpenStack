<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stack Gamepad</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: #111;
    }

    #touchButton {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8vw;
      color: #fff;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      background-color: #222;
    }
  </style>
</head>

<body>
  <div id="touchButton">TAP TO STACK</div>

  <!-- Photon Realtime JavaScript SDK from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/photon-realtime@4.3.2/photon-realtime-module.js"></script>
  <script>
    (function () {
      // 1) Parse URL parameters
      const params = new URLSearchParams(window.location.search);
      const appIdParam = params.get("appId");
      const roomParam = params.get("room");
      const playerParam = parseInt(params.get("player"), 10);

      if (!appIdParam || !roomParam || isNaN(playerParam)) {
        document.getElementById("touchButton").innerText =
          "Invalid URL parameters.\nExpected: ?appId=…&room=…&player=0/1/2";
        console.error("Missing or invalid URL parameters.");
        return;
      }

      // 2) Create a LoadBalancingClient and connect
      const region = "eu"; // Must match the Unity host’s region
      const client = new Photon.Realtime.LoadBalancingClient(
        Photon.Realtime.ConnectionProtocol.Udp
      );
      client.setLogLevel(Photon.Realtime.DebugLevel.WARNING);

      // Hook up callbacks
      client.addCallbackTarget({
        onConnected: () => console.log("[JS] onConnected"),
        onConnectedToMaster: () => {
          console.log("[JS] onConnectedToMaster → joining room:", roomParam);
          client.joinRoom(roomParam);
        },
        onJoinRoomFailed: (code, msg) => {
          console.error("[JS] onJoinRoomFailed(", code, "): ", msg);
          document.getElementById("touchButton").innerText =
            "Failed to join room.\nCheck console.";
        },
        onJoinedRoom: () => {
          console.log("[JS] onJoinedRoom()");
          document.getElementById("touchButton").innerText =
            "IN STACK ROOM\nPLAYER " + playerParam;
        },
        onError: (errorCode, errorMsg) => {
          console.error("[JS] Photon Error:", errorCode, errorMsg);
        },
        onEvent: (evData) => {
          // Clients likely don’t need to receive any events; we only send button presses.
        }
      });

      // 3) Connect using settings
      client.connectUsingSettings({
        AppIdRealtime: appIdParam,
        AppVersion: "1.0",
        FixedRegion: region
      });

      // 4) On “touchstart” (or “mousedown”), send a RaiseEvent
      const buttonDiv = document.getElementById("touchButton");
      buttonDiv.addEventListener("touchstart", sendTap, { passive: false });
      buttonDiv.addEventListener("mousedown", sendTap);

      function sendTap(evt) {
        evt.preventDefault();
        if (client.getState() !== Photon.Realtime.ClientState.Joined) {
          console.warn("[JS] tried to tap before joining room.");
          return;
        }
        // Event content is just the integer player index.
        client.raiseEvent(
          /* eventCode = */ 1,
          /* content   = */ playerParam,
          /* options   = */ new Photon.Realtime.RaiseEventOptions({
          Receivers: Photon.Realtime.ReceiverGroup.All
        }),
          /* sendOpts  = */ new Photon.Realtime.SendOptions({ Reliability: true })
        );
        // (We choose Reliable = true, so no taps get lost.)
      }
    })();
  </script>
</body>

</html>