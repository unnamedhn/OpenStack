<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Stack Gamepad</title>
  <style>
    /* Full‐screen black background */
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background-color: #111;
      color: #eee;
      font-family: Arial, sans-serif;
      overflow: hidden;
      touch-action: manipulation;
    }

    /* Container flex‐centers everything */
    #container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* Status text at top */
    #statusText {
      position: absolute;
      top: 5%;
      width: 100%;
      text-align: center;
      font-size: 4vw;
      line-height: 1.2;
      pointer-events: none;
      user-select: none;
    }

    /* Full‐screen tappable button area */
    #touchButton {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #222;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8vw;
      color: #fff;
      user-select: none;
    }

    /* Debug log area at bottom */
    #logArea {
      position: absolute;
      bottom: 0;
      width: 100%;
      max-height: 25%;
      overflow-y: auto;
      background-color: rgba(0, 0, 0, 0.7);
      font-size: 2.5vw;
      line-height: 1.1;
      padding: 0.5em;
      box-sizing: border-box;
      display: block;
      /* Enable for debugging */
    }

    #logArea div {
      margin-bottom: 0.2em;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="statusText">Connecting…</div>
    <div id="touchButton">TAP TO STACK</div>
    <div id="logArea"></div>
  </div>

  <!-- Photon Realtime JS SDK v4.3.2 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/photon/4.3.2/photon.min.js"></script>
  <script>
    (function () {
      //────────────────────────────────────────────────────────────────────────
      // 1) Simple logger: writes to console and (optionally) #logArea
      //────────────────────────────────────────────────────────────────────────
      function logDebug(msg, ...args) {
        console.log(msg, ...args);
        const logArea = document.getElementById("logArea");
        if (logArea && logArea.style.display === "block") {
          const line = document.createElement("div");
          line.textContent = "[JS] " + msg + (args.length ? " " + args.join(" ") : "");
          logArea.appendChild(line);
          logArea.scrollTop = logArea.scrollHeight;

          // Keep only last 50 lines
          while (logArea.children.length > 50) {
            logArea.removeChild(logArea.firstChild);
          }
        }
      }

      //────────────────────────────────────────────────────────────────────────
      // 2) Parse & validate URL params: appId, room, player
      //    Usage: ?appId=YOUR_APP_ID&room=OpenStackRoom&player=0
      //────────────────────────────────────────────────────────────────────────
      const params = new URLSearchParams(window.location.search);
      const appIdParam = params.get("appId");
      const roomParam = params.get("room");
      const playerStr = params.get("player");
      const statusText = document.getElementById("statusText");
      const touchDiv = document.getElementById("touchButton");

      if (!appIdParam || !roomParam || playerStr === null) {
        statusText.textContent =
          "❗ Invalid parameters.\nUse: ?appId=…&room=…&player=0/1/2";
        console.error("Missing or invalid URL params. Must include appId, room, player.");
        return;
      }

      const playerIndex = parseInt(playerStr, 10);
      if (isNaN(playerIndex) || playerIndex < 0) {
        statusText.textContent = "❗ Invalid player index (must be 0, 1, 2, …).";
        console.error("player query‐param is not a non‐negative integer:", playerStr);
        return;
      }

      logDebug("Initializing with params:", { appId: appIdParam, room: roomParam, player: playerIndex });

      //────────────────────────────────────────────────────────────────────────
      // 3) Instantiate LoadBalancingClient with secure WSS
      //────────────────────────────────────────────────────────────────────────
      let client;
      let roomJoinAttempted = false;
      let connectionTimeout;

      try {
        client = new Photon.LoadBalancing.LoadBalancingClient(
          Photon.ConnectionProtocol.Wss,  // ← Wss required for HTTPS pages
          appIdParam,                    // Photon Cloud AppId
          "1.0"                          // AppVersion (match Unity side)
        );

        // Configure logger
        client.logger = new Photon.Logger("GamepadJS");
        client.logger.setLevel(Photon.LogLevel.INFO);

        // Disable the built‐in "join default lobby" step
        client.autoJoinLobby = false;

        logDebug("LoadBalancingClient created successfully");
      } catch (error) {
        logDebug("Failed to create LoadBalancingClient:", error);
        statusText.textContent = "❌ Failed to initialize Photon client";
        return;
      }

      //────────────────────────────────────────────────────────────────────────
      // 4) Connection timeout handler
      //────────────────────────────────────────────────────────────────────────
      function setConnectionTimeout() {
        clearTimeout(connectionTimeout);
        connectionTimeout = setTimeout(() => {
          logDebug("Connection timeout - attempting to reconnect...");
          statusText.textContent = "⏱️ Connection timeout - retrying...";

          // Try to reconnect
          setTimeout(() => {
            if (client.state === Photon.LoadBalancing.LoadBalancingClient.State.Disconnected) {
              logDebug("Attempting reconnection");
              client.connectToRegionMaster("eu");
            }
          }, 2000);
        }, 15000); // 15 second timeout
      }

      //────────────────────────────────────────────────────────────────────────
      // 5) onStateChange: update #statusText with a readable state
      //────────────────────────────────────────────────────────────────────────
      client.onStateChange = function (state) {
        const stateName = Photon.LoadBalancing.LoadBalancingClient.StateToName(state);
        let displayText;

        logDebug("State changed to:", stateName, "| State code:", state);

        switch (stateName) {
          case "ConnectingToNameServer":
            displayText = "Connecting to NameServer…";
            setConnectionTimeout();
            break;
          case "ConnectedToNameServer":
            displayText = "Authenticated by NameServer…";
            clearTimeout(connectionTimeout);
            break;
          case "ConnectingToMasterserver":
            displayText = "Connecting to Master…";
            setConnectionTimeout();
            break;
          case "ConnectedToMaster":
            displayText = "Connected to Master. Joining Room…";
            clearTimeout(connectionTimeout);
            roomJoinAttempted = false; // Reset flag
            break;
          case "Joining":
            displayText = `Joining Room "${roomParam}"…`;
            setConnectionTimeout();
            break;
          case "JoinedToRoom":
            displayText = `✅ Joined Room "${roomParam}"\nPLAYER ${playerIndex}`;
            clearTimeout(connectionTimeout);
            break;
          case "Disconnecting":
            displayText = "Disconnecting…";
            break;
          case "Disconnected":
            displayText = "❌ Disconnected";
            clearTimeout(connectionTimeout);
            break;
          default:
            displayText = stateName;
        }

        statusText.textContent = displayText;
        logDebug("Display updated:", displayText.replace("\n", " | "));
      };

      //────────────────────────────────────────────────────────────────────────
      // 6) onConnectedToMaster: use joinRoom to join or create room
      //────────────────────────────────────────────────────────────────────────
      client.onConnectedToMaster = function () {
        logDebug("onConnectedToMaster called");

        // Prevent multiple join attempts
        if (roomJoinAttempted) {
          logDebug("Room join already attempted, skipping");
          return;
        }

        roomJoinAttempted = true;

        // Small delay to ensure client is fully ready
        setTimeout(() => {
          logDebug("Attempting to join room:", roomParam);

          try {
            // First try to join existing room
            const joinSuccess = client.joinRoom(roomParam);

            if (!joinSuccess) {
              logDebug("Direct joinRoom failed, trying joinOrCreateRoom");

              // If direct join fails, try join or create
              const joinOrCreateSuccess = client.joinRoom(roomParam, {}, {
                MaxPlayers: 10,
                IsVisible: true,
                IsOpen: true
              });

              if (!joinOrCreateSuccess) {
                logDebug("Both joinRoom attempts failed");
                statusText.textContent = "❌ Failed to initiate room join";
              }
            } else {
              logDebug("Direct joinRoom succeeded");
            }
          } catch (error) {
            logDebug("Exception during room join:", error);
            statusText.textContent = "❌ Error joining room: " + error.message;
          }
        }, 100);
      };

      //────────────────────────────────────────────────────────────────────────
      // 7) onJoinRoom: called when successfully joined a room
      //────────────────────────────────────────────────────────────────────────
      client.onJoinRoom = function (createdByMe) {
        logDebug("onJoinRoom called - joined", roomParam, "createdByMe:", createdByMe);
        clearTimeout(connectionTimeout);
      };

      //────────────────────────────────────────────────────────────────────────
      // 8) onJoinRoomFailed: handle join failures and try to create room
      //────────────────────────────────────────────────────────────────────────
      client.onJoinRoomFailed = function (returnCode, errorMsg) {
        console.error("onJoinRoomFailed(", returnCode, "):", errorMsg);
        logDebug("onJoinRoomFailed:", returnCode, errorMsg);

        // If room doesn't exist (code 32760), try to create it
        if (returnCode === 32760) {
          logDebug("Room doesn't exist, attempting to create:", roomParam);

          try {
            const createSuccess = client.createRoom(roomParam, {
              MaxPlayers: 10,
              IsVisible: true,
              IsOpen: true
            });

            if (!createSuccess) {
              logDebug("createRoom call failed");
              statusText.textContent = `❌ Failed to create room "${roomParam}"`;
            } else {
              logDebug("createRoom call succeeded");
              statusText.textContent = `Creating room "${roomParam}"...`;
            }
          } catch (error) {
            logDebug("Exception during room creation:", error);
            statusText.textContent = "❌ Error creating room: " + error.message;
          }
        } else {
          statusText.textContent = `❌ Failed to join "${roomParam}"\nError: ${errorMsg}`;
        }
      };

      //────────────────────────────────────────────────────────────────────────
      // 9) onCreateRoomFailed: handle room creation failures
      //────────────────────────────────────────────────────────────────────────
      client.onCreateRoomFailed = function (returnCode, errorMsg) {
        console.error("onCreateRoomFailed(", returnCode, "):", errorMsg);
        logDebug("onCreateRoomFailed:", returnCode, errorMsg);
        statusText.textContent = `❌ Failed to create "${roomParam}"\nError: ${errorMsg}`;
      };

      //────────────────────────────────────────────────────────────────────────
      // 10) onOperationResponse: handle operation responses for debugging
      //────────────────────────────────────────────────────────────────────────
      client.onOperationResponse = function (errorCode, errorMsg, code, content) {
        if (errorCode !== 0) {
          logDebug("Operation error:", code, "errorCode:", errorCode, "errorMsg:", errorMsg);
          console.error("Operation error:", code, "errorCode:", errorCode, "errorMsg:", errorMsg);

          // Handle specific operation failures
          if (code === 227) { // JoinRoom operation
            logDebug("JoinRoom operation failed, will be handled by onJoinRoomFailed");
          } else if (code === 227) { // CreateRoom operation
            logDebug("CreateRoom operation failed, will be handled by onCreateRoomFailed");
          }
        } else {
          logDebug("Operation success:", code);
        }
      };

      //────────────────────────────────────────────────────────────────────────
      // 11) onError: generic error handler
      //────────────────────────────────────────────────────────────────────────
      client.onError = function (errorCode, errorMsg) {
        console.error("Photon Error:", errorCode, errorMsg);
        logDebug("Photon Error:", errorCode, errorMsg);

        if (client.state === Photon.LoadBalancing.LoadBalancingClient.State.Disconnected) {
          return;
        }

        statusText.textContent = `⚠️ Photon Error: ${errorMsg}`;
      };

      //────────────────────────────────────────────────────────────────────────
      // 12) Connect to the EU region Master server (secure WebSocket)
      //────────────────────────────────────────────────────────────────────────
      logDebug("Calling connectToRegionMaster('eu')");

      try {
        client.connectToRegionMaster("eu");
        logDebug("connectToRegionMaster call successful");
      } catch (error) {
        logDebug("connectToRegionMaster failed:", error);
        statusText.textContent = "❌ Failed to start connection";
      }

      //────────────────────────────────────────────────────────────────────────
      // 13) On tap/click: send RaiseEvent(eventCode=1, content=playerIndex)
      //      (Only if client.state === JoinedToRoom)
      //────────────────────────────────────────────────────────────────────────
      function sendTap(evt) {
        evt.preventDefault();

        if (client.state !== Photon.LoadBalancing.LoadBalancingClient.State.JoinedToRoom) {
          console.warn("Tap attempted before JoinedToRoom. Current state:",
            Photon.LoadBalancing.LoadBalancingClient.StateToName(client.state));
          logDebug("Tap blocked - not in room. State:",
            Photon.LoadBalancing.LoadBalancingClient.StateToName(client.state));
          return;
        }

        try {
          client.raiseEvent(
            /* eventCode = */ 1,
            /* content   = */ playerIndex,
            /* options   = */ new Photon.LoadBalancing.RaiseEventOptions({
            Receivers: Photon.LoadBalancing.ReceiverGroup.All
          }),
            /* sendOpts  = */ new Photon.SendOptions({ Reliability: true })
          );
          logDebug("Sent tap (event=1) for player", playerIndex);
        } catch (error) {
          logDebug("Error sending tap event:", error);
        }
      }

      // Hook both touchstart and mousedown for mobile & desktop
      touchDiv.addEventListener("touchstart", sendTap, { passive: false });
      touchDiv.addEventListener("mousedown", sendTap);

      //────────────────────────────────────────────────────────────────────────
      // 14) Prevent context menu on long‐press
      //────────────────────────────────────────────────────────────────────────
      window.addEventListener("contextmenu", function (e) {
        e.preventDefault();
      });

      //────────────────────────────────────────────────────────────────────────
      // 15) Cleanup on page unload
      //────────────────────────────────────────────────────────────────────────
      window.addEventListener("beforeunload", function () {
        clearTimeout(connectionTimeout);
        if (client && client.state !== Photon.LoadBalancing.LoadBalancingClient.State.Disconnected) {
          client.disconnect();
        }
      });
    })();
  </script>
</body>

</html>